<?xml version="1.0" encoding="utf-8"?>
<odoo>

  <!-- Portal Menu Item -->
  <template id="portal_my_home_menu_appointments"
    name="Portal My Home: Appointments"
    inherit_id="portal.portal_my_home"
    priority="30">
    <xpath expr="//div[hasclass('o_portal_docs')]" position="inside">
      <t t-call="portal.portal_docs_entry">
        <t t-set="icon">/om_website_booking/static/src/img/appointments.svg</t>
        <t t-set="text">Appointments</t>
        <t t-set="url" t-value="'/my/appointments'"/>
        <t t-set="placeholder_count" t-value="'appointment_count'"/>
      </t>
    </xpath>
  </template>

  <!-- Appointments List Template -->
  <template id="portal_my_appointments" name="My Appointments">
    <t t-call="portal.portal_layout">
      <t t-set="breadcrumbs_searchbar" t-value="True"/>

      <t t-call="portal.portal_searchbar">
        <t t-set="title">My Appointments</t>
      </t>

      <div class="container mt-4">
        <!-- Success/Error Messages -->
        <t t-if="request.params.get('message') == 'cancelled'">
          <div class="alert alert-success alert-dismissible fade show mb-4">
            <i class="fa fa-check-circle me-2"/>
            <strong>Appointment Cancelled</strong> - Your
            appointment has been successfully cancelled. <button type="button" class="btn-close"
              data-bs-dismiss="alert"/>
          </div>
        </t>

        <!-- Filter Tabs -->
        <ul class="nav nav-pills mb-4">
          <li class="nav-item">
            <a t-attf-class="nav-link #{'' if filterby != 'all' else 'active'}"
              href="/my/appointments?filterby=all">
              <i class="fa fa-list me-1"/>All </a>
          </li>
          <li class="nav-item">
            <a t-attf-class="nav-link #{'' if filterby != 'upcoming' else 'active'}"
              href="/my/appointments?filterby=upcoming">
              <i class="fa fa-clock-o me-1"/>Upcoming </a>
          </li>
          <li class="nav-item">
            <a t-attf-class="nav-link #{'' if filterby != 'past' else 'active'}"
              href="/my/appointments?filterby=past">
              <i class="fa fa-history me-1"/>Past </a>
          </li>
          <li class="nav-item">
            <a t-attf-class="nav-link #{'' if filterby != 'confirmed' else 'active'}"
              href="/my/appointments?filterby=confirmed">
              <i class="fa fa-check me-1"/>Confirmed </a>
          </li>
        </ul>

        <!-- Appointments Cards -->
        <t t-if="appointments">
          <div class="row g-3">
            <t t-foreach="appointments" t-as="appointment">
              <div class="col-12 col-md-6 col-lg-4">
                <div class="card appointment-card h-100">
                  <div class="card-body">
                    <!-- Header with reference and status -->
                    <div class="d-flex justify-content-between align-items-start mb-3">
                      <div>
                        <h6 class="card-subtitle text-muted mb-1">
                          <i class="fa fa-hashtag"/>
                          <t t-esc="appointment.reference"/>
                        </h6>
                        <h5 class="card-title mb-0">
                          <t t-esc="appointment.service_id.name"/>
                        </h5>
                      </div>
                      <span
                        t-attf-class="badge bg-#{
                        'success' if appointment.state == 'confirmed' else
                        'info' if appointment.state == 'draft' else
                        'dark' if appointment.state == 'done' else
                        'secondary'}">
                        <t t-esc="appointment.state.title()"/>
                      </span>
                    </div>

                    <!-- Appointment Details -->
                    <div class="appointment-details">
                      <div class="detail-item mb-2">
                        <i class="fa fa-calendar text-primary me-2"/>
                        <span t-field="appointment.booking_date"
                          t-options='{"widget": "datetime", "format": "MMM dd, yyyy"}'/>
                      </div>
                      <div class="detail-item mb-2">
                        <i class="fa fa-clock-o text-primary me-2"/>
                        <span
                          t-field="appointment.booking_date"
                          t-options='{"widget": "datetime", "time_only": true}'/>
                      </div>
                      <div class="detail-item mb-3">
                        <i class="fa fa-money text-primary me-2"/>
                        <strong> $<t t-esc="'{:,.2f}'.format(appointment.service_id.price)"/>
                        </strong>
                      </div>
                    </div>

                    <!-- Actions -->
                    <div class="card-actions mt-auto">
                      <a t-attf-href="/my/appointments/#{appointment.id}"
                        class="btn btn-sm btn-outline-primary w-100">
                        <i class="fa fa-eye me-1"/>View Details </a>
                    </div>
                  </div>
                </div>
              </div>
            </t>
          </div>

          <!-- Pagination -->
          <div t-if="pager" class="mt-4">
            <t t-call="portal.pager"/>
          </div>
        </t>

        <!-- Empty State -->
        <t t-else="">
          <div class="empty-state text-center py-5">
            <div class="empty-icon mb-3">
              <i class="fa fa-calendar-times-o"/>
            </div>
            <h4>No Appointments Yet</h4>
            <p class="text-muted mb-4">You haven't booked any services.</p>
            <a href="/booking" class="btn btn-primary">
              <i class="fa fa-calendar-check-o me-1"/>Book a Service Now </a>
          </div>
        </t>
      </div>
    </t>
  </template>

  <!-- Appointment Detail Template -->
  <template id="portal_appointment_detail" name="Appointment Detail">
    <t t-call="portal.portal_layout">
      <div class="container mt-4 mb-5">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item">
              <a href="/my">My Account</a>
            </li>
            <li class="breadcrumb-item">
              <a href="/my/appointments">Appointments</a>
            </li>
            <li class="breadcrumb-item active" t-esc="appointment.reference"/>
          </ol>
        </nav>

        <!-- Error/Success Messages -->
        <t t-if="error == 'invalid_state'">
          <div class="alert alert-warning mb-4">
            <i class="fa fa-exclamation-triangle me-2"/> This appointment cannot be cancelled
            (invalid state). </div>
        </t>
        <t t-if="error == 'too_late'">
          <div class="alert alert-warning mb-4">
            <i class="fa fa-clock-o me-2"/> Cancellation requires 24 hours notice. It's too late to
            cancel this appointment. </div>
        </t>

        <!-- Appointment Detail Card -->
        <div class="card appointment-detail-card">
          <div class="card-header bg-white">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h4 class="mb-1">
                  <i class="fa fa-calendar-check-o text-primary me-2"/>
                  <t t-esc="appointment.service_id.name"/>
                </h4>
                <p class="text-muted mb-0"> Reference: <strong>
                    <t t-esc="appointment.reference"/>
                  </strong>
                </p>
              </div>
              <span
                t-attf-class="badge badge-lg bg-#{
                'success' if appointment.state == 'confirmed' else
                'info' if appointment.state == 'draft' else
                'dark' if appointment.state == 'done' else
                'secondary'}">
                <t t-esc="appointment.state.title()"/>
              </span>
            </div>
          </div>

          <div class="card-body">
            <div class="row">
              <!-- Left Column - Appointment Info -->
              <div class="col-md-6 mb-4">
                <h5 class="section-title mb-3">
                  <i class="fa fa-info-circle me-2"/>Appointment Information </h5>

                <div class="info-group">
                  <div class="info-item">
                    <label><i class="fa fa-calendar me-2"/>Date</label>
                    <p t-field="appointment.booking_date"
                      t-options='{"widget": "datetime", "format": "EEEE, MMMM dd, yyyy"}'/>
                  </div>

                  <div class="info-item">
                    <label><i class="fa fa-clock-o me-2"/>Time</label>
                    <p t-field="appointment.booking_date"
                      t-options='{"widget": "datetime", "time_only": true}'/>
                  </div>

                  <div class="info-item">
                    <label><i class="fa fa-hourglass-half me-2"/>Duration</label>
                    <p>
                      <t t-esc="appointment.service_id.duration_display"/>
                    </p>
                  </div>

                  <div class="info-item">
                    <label><i class="fa fa-money me-2"/>Price</label>
                    <p class="text-primary fw-bold"> $<t
                        t-esc="'{:,.2f}'.format(appointment.service_id.price)"/>
                    </p>
                  </div>
                </div>
              </div>

              <!-- Right Column - Service Info -->
              <div class="col-md-6 mb-4">
                <h5 class="section-title mb-3">
                  <i class="fa fa-cog me-2"/>Service Details </h5>

                <div class="service-info">
                  <t t-if="appointment.service_id.image">
                    <img
                      t-att-src="'data:image/png;base64,%s' % appointment.service_id.image.decode('utf-8')"
                      class="img-fluid rounded mb-3"
                      alt="Service Image"
                      style="max-width: 300px; height: auto;"/>
                  </t>

                  <p t-if="appointment.service_id.description" class="text-muted">
                    <t t-esc="appointment.service_id.description"/>
                  </p>
                </div>

                <t t-if="appointment.notes">
                  <h6 class="mt-3"><i class="fa fa-sticky-note-o me-2"/>Your Notes</h6>
                  <p class="text-muted fst-italic">
                    <t t-esc="appointment.notes"/>
                  </p>
                </t>
              </div>
            </div>
          </div>

          <!-- Actions Footer -->
          <div class="card-footer bg-light">
            <div class="d-flex gap-2">
              <a href="/my/appointments" class="btn btn-outline-secondary">
                <i class="fa fa-arrow-left me-1"/>Back to List </a>

              <t t-if="can_cancel">
                <form method="post" t-attf-action="/my/appointments/#{appointment.id}/cancel"
                  class="ms-auto">
                  <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                  <button type="submit" class="btn btn-danger"
                    onclick="return confirm('Are you sure you want to cancel this appointment?')">
                    <i class="fa fa-times me-1"/>Cancel Appointment </button>
                </form>
              </t>
            </div>
          </div>
        </div>
      </div>
    </t>
  </template>

</odoo>